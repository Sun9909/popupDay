<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="flower.popupday.notice.notice.dao.NotcieDAO">

    <resultMap  type="noticeDTO" id="noticeResult">
        <id property="notice_id" column="notice_id"/>
        <result property="user_id" column="user_id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="created_date" column="created_date"/>
    </resultMap>

    <resultMap type="noticeimageDTO" id="imgResult">
        <result property="notice_id" column="notice_id"/>
        <result property="image_file_name" column="image_file_name"/>
        <result property="notice_image_id" column="notice_image_id"/>
    </resultMap>
    <!-- 전체 글 조회 LIMIT ?,10  갯수(count) 받음 -->
<!--    <select id="selectAllArticles" resultMap="articleResult" parameterType="int">-->
<!--        select notice_id, title, content, date_created from notice_tbl order by notice_id desc LIMIT #{count}, 10-->
<!--    </select>-->

    <!-- 전체 글 목록 수 조회 -->
    <select id="selectTotalNotice" resultType="int">
      <![CDATA[
        select count(*) from notice_tbl
        ]]>
   </select>

    <!-- 글 번호 생성 -->
    <select id="getNewNoticeNo" resultType="int">
      <![CDATA[
        SELECT IFNULL(MAX(notice_id), 0) + 1 FROM notice_tbl
        ]]>
   </select>

    <!-- 선택한 글 상세 내용 메서드 -->
    <!-- param 글번호(int)를 받아 articleDTO로 보내줌 -->
<!--    <select id="selectArticles" resultType="articleDTO" parameterType="int">-->
<!--      <![CDATA[-->
<!--        select * from notice_tbl where notice_id=#{notice_id}-->
<!--        ]]>-->
<!--   </select>-->

    <!-- 새 글 추가 (글번호 생성 후 새 글 추가 호출)  Map으로 받음 여러개의 이미지 imageFileName에는 null값이 들어감 -->
    <insert id="insertNewNotice" parameterType="java.util.Map" useGeneratedKeys="true" keyProperty="notice_id">
      <![CDATA[
        insert into notice_tbl(user_id, title, content, created_date) values(#{user_id},#{title},#{content},now())
        ]]>
   </insert>

<!--    <select id="selectImageFileList" resultMap="imgResult" parameterType="int"> &lt;!&ndash; 글번호 받음 &ndash;&gt;-->
<!--        select * from imagefile_tbl where articleNo=#{notice_id}-->
<!--    </select>-->

    <!-- insert all : 오라클 및 여러 데이터베이스에서 insert문 반복 수행
    <insert id="insertNewImages" parameterType="java.util.Map">  serparator 구분자 , dual : 임시테이블 , item에 넣어서 for문 돌림
            <foreach item="item" collection="list" open="INSERT ALL" separator="" close="select * from dual">
                into imageFile_tbl(image_file_name, regDate, articleNo) values (#{item.image_file_name}, sysdate(), #{item.articleNo})
            </foreach>
    </insert> -->

    <!-- 여러개의 이미지 -->
    <insert id="insertNewImages" parameterType="java.util.Map"> <!-- map에 있는 articleNo를 가져와 글번호를(글쓴거의 글번호) 가져옴 -->
        insert into notice_tbl values
        <foreach collection="imageFileList" item="item" separator=","> <!-- 구분자 , 로 -->
            (#{item.imageFileNo}, #{item.image_file_name}, sysdate(), #{notice_id})
        </foreach> <!-- values에 있는 값 업데이트 -->
    </insert>


    <!-- 이미지 여러개 글 수정 (제목과 내용만 수정하면 돼서 간단함) -->
    <update id="updateNotice" parameterType="java.util.Map">
        update notice_tbl set title=#{title}, content=#{content} where notice_id=#{notice_id}
    </update>

    <!-- 이미지 여러개 글 수정  같은 글번호를 찾아서 update-->
    <update id="updateImage" parameterType="java.util.Map">
        <foreach item="item" collection="imageFileList" separator=";"> <!-- 이미지 담겨있는 곳 -->
            <if test="#{item.image_file_name} != null and #{item.image_file_name} != ''" > <!-- 이미지를 선택한것만 업데이트 -->
                update imagefile_tbl set image_file_name=#{item.image_file_name} where imageFileNo=#{item.imageFileNo} and #{item.image_file_name} != ''
            </if>
        </foreach>
    </update>

    <!-- delete -->
    <!-- 글삭제 , 글번호를 받아서 (내용)-->
<!--    <delete id="deleteArticle" parameterType="int">-->
<!--      <![CDATA[-->
<!--        delete from notice_tbl where articleNo=#{notice_id}-->
<!--        ]]>-->
<!--   </delete>-->

    <!-- 글삭제 , 글번호를 받아서 (이미지)-->
<!--    <delete id="deleteImage" parameterType="int">-->
<!--      <![CDATA[-->
<!--        delete from imageFile_tbl where articleNo=#{notice_id}-->
<!--        ]]>-->
<!--   </delete>-->

</mapper>
